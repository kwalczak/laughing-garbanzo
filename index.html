<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Frost Map Viewer</title>

  <!-- Leaflet + Clustering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    #map {
      height: 100vh;
      width: 100%;
    }

    .popup-content {
      max-width: 600px;
      font-size: 12px;
      white-space: nowrap;
      overflow-x: auto;
    }

    .popup-content div {
      margin: 0;
      padding: 0;
    }

    .popup-content strong {
      display: inline-block;
      min-width: 100px;
    }

    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  const map = L.map('map').setView([65.0, 15.0], 5);
  let chart = null;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Load stations
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const markers = L.markerClusterGroup();

  const baseStationsUrl = 'https://laughing-garbanzo-yh5u.onrender.com/stations';
  const precipStationsUrl = 'https://laughing-garbanzo-yh5u.onrender.com/stations?elements=sum(precipitation_amount P1D)';

  let baseStations = {};
  let precipStations = {};

  Promise.all([
    fetch(baseStationsUrl).then(res => res.json()),
    fetch(precipStationsUrl).then(res => res.json())
  ])
  .then(([baseData, precipData]) => {
    (baseData.data || []).forEach(station => {
      baseStations[station.id] = station;
    });

    (precipData.data || []).forEach(station => {
      precipStations[station.id] = station;
    });

    // Merge and render
    const allStationIds = new Set([
      ...Object.keys(baseStations),
      ...Object.keys(precipStations)
    ]);

    allStationIds.forEach(stationId => {
      const station = baseStations[stationId] || precipStations[stationId];
      const lat = station.geometry?.coordinates[1];
      const lon = station.geometry?.coordinates[0];

      if (lat && lon) {
        const isPrecip = !!precipStations[stationId];
        const marker = L.marker([lat, lon], {
          icon: getColorMarker(isPrecip ? 'green' : 'orange')
        });

        marker.on('click', () => {
          marker.bindPopup('Loading...').openPopup();

          fetch(`https://laughing-garbanzo-yh5u.onrender.com/available-timeseries?source=${station.id}`)
          .then(res => res.json())
          .then(obs => {
            const html = formatCompactTooltipWithObservations(station, obs);
            marker.setPopupContent(html);
          })
          .catch(err => {
            marker.setPopupContent('Failed to load data');
            console.error(err);
          });
        });

        markers.addLayer(marker);
      }
    });

    map.addLayer(markers);
  })
  .catch(err => {
    console.error('Error loading stations:', err);
  });

  function formatStationWithObservations(station, obs) {
    let html = `<div class="popup-content">`;
    for (const [k, v] of Object.entries(station)) {
      const val = (typeof v === 'object') ? JSON.stringify(v) : v;
      html += `<div><strong>${k}:</strong> ${val}</div>`;
    }

    if (obs?.data?.length > 0) {
      html += `<hr><div><strong>Observations:</strong></div>`;
      obs.data.forEach(item => {
        const uri = encodeURIComponent(item.uri);
        html += `<div style="color:blue;cursor:pointer;text-decoration:underline;"
                    onclick="fetchObservationUri('${uri}')">
                  ${item.elementId} (${item.unit}) â€“ ${item.status}
                 </div>`;
      });
      html += `<div id="obs-graph" style="margin-top:10px;"></div>`;
    } else {
      html += `<div><em>No observations available</em></div>`;
    }

    html += `</div>`;
    return html;
  }

  function fetchObservationUri(uri) {
    const graphDiv = document.getElementById('obs-graph');
    if (!graphDiv) {
      return;
    }
    graphDiv.innerHTML = 'Loading chart...';

    fetch(`https://laughing-garbanzo-yh5u.onrender.com/observations-by-uri?uri=${uri}`)
    .then(res => res.json())
    .then(data => {
      const entries = data.data || [];

      const labels = [];
      const values = [];

      entries.forEach(entry => {
        const date = entry.referenceTime.substring(0, 10);
        const obs = entry.observations?.[0];
        if (obs) {
          labels.push(date);
          const val = obs.value === -1 ? null : obs.value;
          values.push(val);
        }
      });

      if (chart) {
        chart.destroy();
      }

      const canvas = document.createElement('canvas');
      graphDiv.innerHTML = '';
      graphDiv.appendChild(canvas);

      chart = new Chart(canvas, {
        type: 'bar',  // ðŸ” Changed from 'line' to 'bar'
        data: {
          labels: labels,
          datasets: [{
            label: 'Observation values (last 5 days)',
            data: values,
            backgroundColor: 'rgba(0, 123, 255, 0.6)',
            borderColor: 'rgba(0, 123, 255, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {display: true, text: 'Date'}
            },
            y: {
              beginAtZero: true,
              title: {display: true, text: 'Value'}
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: context => {
                  const val = context.raw;
                  return val !== null ? `${val} mm` : 'No data';
                }
              }
            }
          }
        }
      });
    })
    .catch(err => {
      console.error('Chart error:', err);
      graphDiv.innerHTML = 'Error loading chart';
    });
  }

  function getColorMarker(color) {
    return new L.Icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
  }
</script>
</body>
</html>